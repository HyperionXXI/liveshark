name: release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g. v0.1.0)"
        required: true

permissions:
  contents: write

jobs:
  windows-build:
    runs-on: windows-latest
    steps:
      - name: resolve tag
        id: tag
        shell: bash
        run: |
          if [ -n "${{ inputs.tag }}" ]; then
            echo "tag=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
          fi
      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.tag.outputs.tag }}
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
      - name: build (cli)
        run: cargo build -p liveshark-cli --release
      - name: package
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          Copy-Item target\release\liveshark.exe dist\
          Copy-Item README.md dist\README.md
          if (Test-Path LICENSE-MIT) { Copy-Item LICENSE-MIT dist\LICENSE-MIT }
          if (Test-Path LICENSE-APACHE) { Copy-Item LICENSE-APACHE dist\LICENSE-APACHE }
          if (Test-Path LICENSE-CC-BY-4.0) { Copy-Item LICENSE-CC-BY-4.0 dist\LICENSE-CC-BY-4.0 }
          if (Test-Path NOTICE) { Copy-Item NOTICE dist\NOTICE }
          if (Test-Path gui\report-viewer) {
            New-Item -ItemType Directory -Force -Path dist\report-viewer | Out-Null
            Copy-Item -Recurse gui\report-viewer\* dist\report-viewer\
          }
          $tag = "${{ steps.tag.outputs.tag }}"
          $zip = "liveshark-$tag-windows-x86_64.zip"
          Compress-Archive -Path dist\* -DestinationPath $zip
      - name: publish release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          generate_release_notes: true
          files: liveshark-${{ steps.tag.outputs.tag }}-windows-x86_64.zip
