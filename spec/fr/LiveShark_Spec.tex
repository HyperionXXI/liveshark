\documentclass[11pt]{article}

\input{../common/liveshark-style.tex}
\input{../common/liveshark-macros.tex}

% --- Langue (XeLaTeX) ---
\usepackage{polyglossia}
\setdefaultlanguage{french}

% --- Mots-clés normatifs en français (intention BCP 14 / RFC 2119 & RFC 8174) ---
\newcommand{\DOIT}{\textbf{DOIT}}
\newcommand{\NEDOITPAS}{\textbf{NE DOIT PAS}}
\newcommand{\DEVRAIT}{\textbf{DEVRAIT}}
\newcommand{\NEDEVRAITPAS}{\textbf{NE DEVRAIT PAS}}
\newcommand{\PEUT}{\textbf{PEUT}}

% Titres standards en français
\addto\captionsfrench{
  \renewcommand{\contentsname}{Sommaire}
}

\usepackage{csquotes}
\usepackage{biblatex}
\addbibresource{../common/references.bib}

\title{\sffamily\bfseries\color{LSBlue}LiveShark\\\large Spécification (PDF imprimable) v0.1}
\author{\sffamily Florian Keller}
\date{\sffamily Brouillon - \today\\\small\textsf{Langue de référence : EN}}

\begin{document}
\maketitle
\vspace{0.6em}
\noindent\textbf{Note de langue.} Cette version française est une traduction destinée à faciliter la relecture. En cas de divergence, la version anglaise (EN) est la référence pour les IDs d’exigences et les contrats, sauf décision explicite contraire.
\par\medskip

\begin{tcolorbox}
\textbf{Périmètre.} LiveShark est un analyseur \textbf{passif} pour les réseaux de contrôle de spectacle (Art-Net, sACN).
Il se concentre sur l'\textbf{analyse hors-ligne de captures PCAP}, la \textbf{reconstruction de trames DMX},
la \textbf{détection automatique de conflits} et des \textbf{rapports reproductibles}.\\
\textbf{Public.} Le texte vise aussi des \textbf{non-spécialistes du développement logiciel} (techniciens lumière, intégrateurs, QA).
Un \textbf{mode suivi} est prévu pour une analyse en quasi temps réel d'un fichier de capture en cours d'écriture (outil externe).\\
L'interface idéale pour l'utilisateur final est une \textbf{interface graphique (GUI)} bien conçue ; l'\textbf{interface en ligne de commande (CLI)} reste scriptable et produit les mêmes données.
\end{tcolorbox}

\newpage
\tableofcontents
\newpage

\section{Terminologie et conventions}

\subsection{Version de référence et politique de traduction}
\textbf{Version de référence (fait foi).} La spécification anglaise dans \texttt{spec/en} est la \emph{version de référence} :
en cas de divergence ou de traduction incomplète, \textbf{la version anglaise fait foi}.\\
\textbf{Traduction indicative (non normative).} La version française dans \texttt{spec/fr} est une aide à la relecture et peut être
\textbf{en retard}. En cas de différence, la version de référence prévaut.

\subsection{Mots-clés normatifs}
Les mots-clés \DOIT, \NEDOITPAS, \DEVRAIT, \NEDEVRAITPAS{} et \PEUT{} sont à interpréter au sens de la BCP 14
(RFC 2119 et RFC 8174). Seule l'écriture en \textbf{MAJUSCULES} est normative.

\subsection{Note sur le langage d'implémentation}
LiveShark est développé en \textbf{Rust} pour concilier \textbf{sécurité mémoire} \\ \textbf{et performances}.
Il privilégie aussi la \textbf{portabilité} (Windows, macOS, Linux) et un outillage moderne.
Il s'agit d'un choix d'ingénierie pour v0.1. Cela n'exclut pas l'usage d'autres langages pour des composants futurs.
Le code Rust DEVRAIT suivre le guide de style officiel : \texttt{https://doc.rust-lang.org/style-guide/}.

\subsection{Note sur le terme \enquote{Live}}
Dans le nom du projet, \enquote{Live} fait référence au \textbf{spectacle vivant / contrôle de spectacle} (réseaux lumière), et non à une
garantie de capture en temps réel. La capture en temps réel est optionnelle et pourra être introduite dans des versions ultérieures.
Le diagnostic en quasi temps réel peut être atteint via le mode suivi, sans capture native immédiate.

\subsection{Termes de base}
\begin{adjustbox}{max width=\linewidth}
\begin{tabularx}{\linewidth}{@{}l >{\raggedright\arraybackslash}X@{}}
\toprule
\textbf{Terme} & \textbf{Signification} \\
\midrule
Paquet & Paquet réseau capturé dans un fichier PCAP/PCAPNG. \\
Message protocolaire & Unité décodée au niveau applicatif (ex. ArtDMX, sACN). \\
Trame DMX & État DMX512 (512 slots) reconstruit pour un univers, à un instant donné. \\
Univers & Groupe logique de jusqu'à 512 slots DMX. \\
Source & Émetteur identifié par IP et, si applicable, par identifiant protocolaire\\
(ex. CID sACN). \\
Flux & Tuple unidirectionnel (proto,\\ src ip:port, dst ip:port). \\
\bottomrule
\end{tabularx}
\end{adjustbox}

\subsection{Acronymes}
\begin{adjustbox}{max width=\linewidth}
\begin{tabularx}{\linewidth}{@{}l >{\raggedright\arraybackslash}X@{}}
\toprule
\textbf{Acronyme} & \textbf{Développement} \\
\midrule
ArtDMX & Paquet de données DMX Art-Net \\
Art-Net & Protocole Art-Net \\
BCP & Best Current Practice (bonnes pratiques actuelles) \\
CC-BY-4.0 & Creative Commons Attribution 4.0 International \\
CID & Component Identifier (identifiant de source sACN) \\
CI & Intégration continue \\
CLI & Interface en ligne de commande \\
DMX & Digital Multiplex (DMX512) \\
DMX512 & Digital Multiplex 512 \\
DoD & Definition of Done (critère de fin) \\
FPS / PPS / BPS & Trames / Paquets / Octets\\ par seconde \\
GUI & Interface graphique \\
IP & Internet Protocol (Protocole Internet) \\
JSON & JavaScript Object\\ Notation \\
MIT & Licence MIT \\
MVP & Minimum Viable Product (produit minimum viable) \\
PCAP & Packet Capture \\
PCAPNG & PCAP Next\\ Generation \\
QA & Assurance qualité \\
RFC & Request for Comments \\
sACN & Streaming ACN (ANSI E1.31) \\
UDP & User Datagram Protocol \\
\bottomrule
\end{tabularx}
\end{adjustbox}

\section{Ce que LiveShark est (et n'est pas)}

\subsection{Objectifs}
\begin{itemize}
  \item Analyse hors-ligne de captures PCAP/PCAPNG pour Art-Net et sACN.
  \item Reconstruction de trames DMX (512 slots) et métriques (fps, pps/bps,
  gigue, \\ pertes, rafales).
  \item Détection automatique de \textbf{conflits} (sources multiples sur un même univers avec chevauchement).
  \item Rapports JSON versionnés et reproductibles pour tickets, a posteriori, QA et CI.
\end{itemize}
Voir les Appendices A--D pour les contrats normatifs. Ils couvrent le rapport, les trames, les conflits et les métriques.

\paragraph{Entrée capture (Wireshark non requis).}
LiveShark \NEDOITPAS{} exiger l’application Wireshark (interface graphique) pour fonctionner.
En v0.1, l’entrée est un fichier PCAP/PCAPNG produit par des outils standards (p.\,ex. \texttt{tcpdump} sous Linux, \texttt{pktmon} sous Windows, ou tout outil de capture exportant PCAP/PCAPNG).
La capture en direct est un objectif futur et \PEUT{} être ajoutée plus tard via libpcap/Npcap (sans changer le schéma de rapport).

\subsection{Stratégie \emph{hors ligne en priorité} (intention produit)}
LiveShark est conçu comme un analyseur \emph{hors ligne en priorité} : les premières versions se concentrent sur l'analyse a posteriori
de captures PCAP/PCAPNG afin de maximiser la robustesse, la reproductibilité et la simplicité de support.
Il s'agit d'un choix d'ingénierie volontaire, et non d'une limitation produit.
La capture en direct / l'analyse en ligne est un objectif futur explicite et \PEUT{} être implémentée une fois le cœur hors ligne validé.

\textbf{Compatibilité future.} La chaîne d'analyse \DOIT{} être architecturé afin que l'entrée des paquets puisse provenir :
(a) d'un lecteur de fichiers (PCAP/PCAPNG), ou (b) d'une source de capture en direct (future).
Aucune hypothèse « hors ligne uniquement » \NEDOITPAS{} être intégrée au modèle métier (trames, conflits, rapports).

Le mode suivi constitue une trajectoire pragmatique pour un diagnostic fiable pendant la préparation du spectacle et pendant le spectacle :
il analyse un fichier de capture au fur et à mesure de son écriture, sans imposer une capture native immédiate.

LiveShark PEUT produire des \emph{indices de causes probables} uniquement comme heuristiques et séparés des mesures. Tout indice \DOIT{}
être justifié par des indicateurs mesurables (pertes, gigue, rafales, asymétries temporelles) et \NEDOITPAS{} être présenté comme une
cause certaine. La localisation robuste des pertes peut nécessiter plusieurs points de capture (par exemple avant et après un segment sans fil)
et n'est rapportée que lorsque les éléments disponibles le permettent.

\subsection{Non-objectifs}
\begin{itemize}
  \item LiveShark ne vise \textbf{pas} à remplacer Wireshark.
  \item LiveShark est \textbf{passif} : il n'injecte pas de trafic.
  \item ``Laser over IP'' démarre en mode \textbf{métriques de flux UDP} uniquement ; la reconstruction de trames laser est hors scope v0.1.
\end{itemize}

\subsection{Extensions optionnelles (registre non normatif)}
Chaque extension \DOIT{} améliorer un diagnostic exploitable (perte, gigue, rafales, conflits, multi-sources) et \DOIT{} rester reproductible (mêmes entrées $\rightarrow$ mêmes sorties).
Ces candidats sont non normatifs et hors périmètre v0.1.

Chaque extension déclare son niveau de support :
\begin{itemize}
  \item \textbf{Niveau flux :} métriques réseau sans sémantique métier du contenu.
  \item \textbf{Niveau messages/trames :} décodage structuré avec un modèle métier stable.
\end{itemize}

LiveShark \PEUT{} fournir des \emph{pistes de causes probables} uniquement sous forme d'heuristiques. Ces pistes \DOIT{} être justifiées par des motifs observables et \NEDOITPAS{} être présentées comme des causes certaines.

\begin{itemize}
  \item \textbf{OSC (Messages) :} chronologie des messages de contrôle ; corrélation avec anomalies DMX/réseau.
  \item \textbf{Protocoles de type RTP (Messages) :} trous de séquence, gigue, désordre ; base pour bilans de santé (ex. AES67).
  \item \textbf{Infrastructure réseau (Flux) :} motifs IGMP/mDNS/DHCP/ARP/DNS ; problèmes de multicast/découverte/adressage.
\end{itemize}

\section{Architecture (concept)}
\begin{figure}[H]
\centering
\begin{adjustbox}{max width=\linewidth}
\input{../common/figures/dataflow.tex}
\end{adjustbox}
\caption{Pipeline conceptuel d'analyse hors-ligne (niveau élevé).}
\textit{Note :} La chaîne d'analyse accepte actuellement (v0.1) uniquement des fichiers PCAP/PCAPNG. L'entrée depuis une capture en direct
est un objectif futur (v0.3+) conforme à l'exigence d'abstraction d'entrée en P0.
\end{figure}

\section{Métriques (valeurs par défaut)}
Par défaut :
\begin{itemize}
  \item \textbf{Fenêtre fps :} 5.0 s (glissante)
  \item \textbf{Fenêtre gigue :} 10.0 s (glissante)
  \item \textbf{Fenêtre de pic :} 1.0 s (glissante) pour \texttt{pps\_peak\_1s} / \texttt{bps\_peak\_1s}
\end{itemize}
Les fenêtres glissantes incluent les paquets dont l'horodatage est dans $[t - W, t]$ (bornes incluses).
\subsection{Définitions des métriques (minimal)}
\begin{itemize}
  \item \textbf{pps/bps :} paquets/octets par seconde en moyenne sur l'intervalle actif du flux $[t_{first}, t_{last}]$. Unités paquets/s et octets/s. Omettre si moins de deux paquets horodatés existent ou si la durée active est indisponible. (Rapporté dans \texttt{flows[]}.)
  \item \textbf{fps (univers) :} trames DMX reconstruites par seconde sur une fenêtre glissante de 5.0 s.
  \item \textbf{gigue (IAT) :} moyenne des variations absolues entre temps d'arrivée successifs sur une fenêtre glissante de 10.0 s : $\text{mean}(|IAT_i - IAT_{i-1}|)$. L'unité est la milliseconde pour \texttt{iat\_jitter\_ms} et \texttt{jitter\_ms}. La valeur rapportée est le pic (maximum) sur l'ensemble des fenêtres.
  \item \textbf{perte (observée) :} lorsque des numéros de séquence existent (ex. sACN), la perte est rapportée comme des trous observés au point de capture. En v0.1, la perte \DOIT{} être rapportée uniquement lorsque des numéros de séquence existent ; sinon, les champs de perte sont omis. Cela ne prouve pas une perte côté récepteur.
\end{itemize}
Les métriques optionnelles sont omises lorsqu'elles ne sont pas calculables ; leur absence ne signifie pas zéro.
Voir l'Appendice D pour les définitions opérationnelles et les unités.

\paragraph{Métriques diagnostiques supplémentaires (additives)}
Ces champs sont des ajouts optionnels ; un ajout additif \NEDOITPAS{} incrémenter \texttt{report\_version}.
\begin{itemize}
  \item \textbf{max\_iat\_ms (flux) :} par flux UDP, maximum des intervalles d'arrivée $\max(t_i - t_{i-1})$ sur toute la capture. Unité : millisecondes, entier arrondi au plus proche. Omettre si moins de deux paquets horodatés existent pour le flux.
  \item \textbf{pps\_peak\_1s / bps\_peak\_1s (flux) :} par flux UDP, pics de charge (paquets/s et octets/s) sur fenêtre \emph{glissante} de 1.0 s. Règle : inclure les paquets dont l'horodatage est dans $[t-1.0, t]$ (bornes incluses). Reporter le maximum des comptes de fenêtre en entier. Omettre si le flux a moins de deux paquets horodatés ou si la durée couverte est $< 1.0$ s.
  \item \textbf{dup\_packets / reordered\_packets (univers sACN) :} par univers, compteurs agrégés sur les sources sACN disposant de numéros de séquence. En ordre temporel de capture, \texttt{dup\_packets} s'incrémente quand $\texttt{seq} = \texttt{seq\_prev}$. \texttt{reordered\_packets} s'incrémente quand le delta modulo 256 $\Delta = (\texttt{seq} - \texttt{seq\_prev}) \bmod 256$ est dans $[128, 255]$ (demi-plage arrière). Le wrap-around (ex. 254, 255, 0, 1) n'est pas considéré comme un réordonnancement. Omettre ces champs si aucun numéro de séquence n'est disponible.
\end{itemize}



\subsection{Compatibilité et contrat de consommation}
Les ajouts au rapport JSON sont non bloquants : un consommateur \DOIT{} ignorer les champs inconnus.
Les métriques optionnelles sont omises (absentes) lorsqu'elles ne sont pas calculables ; l'absence d'un champ ne signifie pas zéro.
\texttt{report\_version} indique le schéma de base ; un ajout additif ne nécessite pas forcément un bump si les règles ci-dessus sont respectées.

En v0.1, la perte est rapportée uniquement lorsque des numéros de séquence existent (ex. sACN) ; aucune perte n'est inférée pour Art-Net.

\section{Exigences contractuelles (extrait)}
Ce document est une base de démarrage : les exigences sont volontairement minimales.

\subsection{Priorité P0 (fondations MVP)}
\begin{reqbox}{LS-ARCH-001}{P0}{}
Le cœur \DOIT{} exposer une abstraction d’entrée paquets/événements afin que l’analyse puisse être alimentée par :
(a) un lecteur PCAP/PCAPNG (v0.1), et (b) une source de capture en direct (future), sans modifier le modèle métier ni le schéma de rapport.
\end{reqbox}

\begin{reqbox}{LS-PROD-001}{P0}{}
LiveShark \NEDOITPAS{} exiger l’application Wireshark (interface graphique). Il \DOIT{} accepter des fichiers PCAP/PCAPNG produits par des outils de capture standards.
\end{reqbox}

\begin{reqbox}{LS-FR-001}{P0}{}
LiveShark \DOIT{} ingérer des fichiers PCAP/PCAPNG et lister les flux UDP.
\end{reqbox}

\begin{reqbox}{LS-FR-010}{P0}{}
LiveShark \DOIT{} décoder Art-Net ArtDMX et reconstruire des trames DMX (512 slots) par univers.
\end{reqbox}

\begin{reqbox}{LS-FR-011}{P0}{}
LiveShark \DOIT{} décoder sACN (E1.31) et reconstruire des trames DMX par univers.
\end{reqbox}
\begin{reqbox}{LS-FR-012}{P0}{}
LiveShark \DOIT{} utiliser une définition canonique des trames DMX reconstruites (champs + 512 slots) telle que définie dans l'Appendice B.
\end{reqbox}

\begin{reqbox}{LS-FR-013}{P1}{}
LiveShark \DOIT{} suivre les règles de reconstruction des trames et de comptage du fps définies dans l'Appendice B.
\end{reqbox}


\subsection{Priorité P1 (différenciateurs critiques)}
\begin{reqbox}{LS-CONF-001}{P1}{}
LiveShark \DOIT{} détecter les sources concurrentes : deux sources ou plus sur le même univers avec chevauchement $> 1.0$ s.
\end{reqbox}

\begin{reqbox}{LS-REP-001}{P1}{}
LiveShark \DOIT{} générer un rapport JSON versionné contenant au minimum : résumé de capture, univers (avec sources par univers), flux et conflits.
\end{reqbox}
\begin{reqbox}{LS-REP-002}{P1}{}
Le rapport JSON \DOIT{} être déterministe : l'ordre des listes est stable et les champs volatils sont explicitement définis.
\end{reqbox}

\begin{reqbox}{LS-REP-003}{P1}{}
Le rapport JSON \DOIT{} inclure les champs et types minimaux définis dans l'Appendice A (v0.1).
\end{reqbox}

\begin{reqbox}{LS-REP-004}{P1}{}
Les enregistrements de conflits du rapport JSON \DOIT{} suivre la structure définie dans l'Appendice C.
\end{reqbox}




\begin{reqbox}{LS-CONF-002}{P1}{}
LiveShark \DOIT{} utiliser la définition d'identité de source pour les conflits définie dans l'Appendice C.
\end{reqbox}

\begin{reqbox}{LS-CONF-003}{P1}{}
LiveShark \DOIT{} calculer le chevauchement des conflits selon la définition de l'Appendice C.
\end{reqbox}

\begin{reqbox}{LS-CONF-010}{P1}{}
LiveShark \DOIT{} utiliser la définition d'identité de source pour la détection des conflits définie dans l'Appendice C (CID + repli).
\end{reqbox}

\begin{reqbox}{LS-CONF-011}{P1}{}
LiveShark \DOIT{} calculer le chevauchement des conflits en utilisant les horodatages de capture et le seuil défini dans l'Appendice C (v0.1).
\end{reqbox}

\begin{reqbox}{LS-CONF-012}{P1}{}
Les enregistrements \texttt{conflicts[]} \DOIT{} inclure les champs requis définis dans l'Appendice C (v0.1).
\end{reqbox}

\begin{reqbox}{LS-MET-001}{P1}{}
LiveShark \DOIT{} calculer et rapporter pps/bps/fps/gigue tels que définis dans l'Appendice D (v0.1).
\end{reqbox}


\section{Limites connues (v0.1)}
\begin{itemize}
  \item \textbf{Pourcentage de conformité} : valeur de remplacement (100.0) tant qu'un dénominateur formel n'est pas défini.
  \item \textbf{Détection des conflits} : basée uniquement sur le chevauchement temporel, avec des faux positifs possibles si les sources agissent sur des canaux différents. Le taux de faux positifs n'est pas quantifié en v0.1 ; les conflits sont des signaux à investiguer.
  \item \textbf{Validation sACN} : les paquets avec start code non nul ou un property value count invalide sont ignorés.
\end{itemize}

\section{Contrat opérationnel du viewer (v0.2)}
\textbf{Statut.} Cette section définit le \textbf{contrat opérationnel} pour la GUI v0.2 (timeline + compare). Elle est
\textbf{normative pour v0.2} et informative pour v0.1.

\subsection{Entrées et sécurité}
\begin{itemize}
  \item \textbf{Entrées :} le viewer \DOIT{} accepter un rapport (\enquote{A}) pour la vue timeline, et \PEUT{} accepter un second rapport (\enquote{B}) pour la vue compare.
  \item \textbf{Lecture seule :} le viewer \NEDOITPAS{} modifier les fichiers d'entrée.
  \item \textbf{Hors ligne uniquement :} le viewer \NEDOITPAS{} effectuer de requêtes réseau. Il \DOIT{} fonctionner à partir de fichiers locaux et rester sans dépendances.
  \item \textbf{Pas d'évaluation de contenu embarqué :} le JSON est traité comme des données ; le viewer \NEDOITPAS{} évaluer, interpréter ou exécuter du contenu embarqué.
\end{itemize}

\subsection{Vue timeline (définition)}
\begin{itemize}
  \item \textbf{Bornes de temps :} la timeline \DOIT{} utiliser les bornes \texttt{capture\_summary.time\_start} et \texttt{capture\_summary.time\_end} (RFC3339).
  Les bornes sont \textbf{inclusives}. Si \texttt{time\_start == time\_end}, le viewer \DOIT{} afficher une timeline de \textbf{longueur nulle} (instant unique) et \NEDOITPAS{} inventer une durée.
  Si \texttt{capture\_summary} ou ses bornes sont absentes, le viewer \DOIT{} afficher un état clair \enquote{Timeline indisponible} et \NEDOITPAS{} déduire des bornes.
  \item \textbf{Lignes d'univers :} une ligne d'univers est identifiée par la clé canonique \texttt{(universe, proto)} (alignée avec les règles d'ordre de l'Appendice A). Elle \DOIT{} être sélectionnable et reliée au même univers dans les vues table/détails.
  \item \textbf{Intervalle d'activité (champs v0.2) :} pour chaque ligne d'univers, le rapport \DEVRAIT{} fournir des champs additifs \texttt{first\_seen} et \texttt{last\_seen} (RFC3339)
  indiquant le premier/dernier message valide contribuant à cet univers. Ces champs sont \textbf{optionnels} et \textbf{additifs} et \NEDOITPAS{} modifier \texttt{report\_version}.
  S'ils sont absents, le viewer \DOIT{} afficher l'intervalle comme \texttt{N/A} et \NEDOITPAS{} l'inférer.
  \item \textbf{Conflits sur la timeline (champs v0.2) :} les intervalles de conflits \DEVRAIENT{} être représentés lorsque les champs additifs \texttt{conflicts[].first\_seen} et \texttt{conflicts[].last\_seen} (RFC3339) sont présents.
  S'ils sont absents, les conflits \DOIVENT{} rester visibles dans la liste/détails mais \NEDOIVENTPAS{} être placés sur la timeline.
  \item \textbf{Pas d'inférence :} la timeline \DOIT{} visualiser uniquement les champs mesurés/explicites du rapport. Elle \NEDOITPAS{} créer de nouveaux événements, et \NEDOITPAS{} revendiquer des causes racines.
\end{itemize}

\subsection{Vue compare (définition)}
\begin{itemize}
  \item \textbf{Pas d'inférence (rappel) :} la vue compare \DOIT{} rapporter uniquement les deltas de champs explicites ; elle \NEDOITPAS{} inférer des métriques manquantes ni revendiquer des causes.
  \item \textbf{Diff déterministe :} pour une même paire (A,B), la vue compare \DOIT{} produire les mêmes deltas (pas d'aléatoire, ordre stable).
  \item \textbf{Clés et ordre :} les comparaisons \DOIVENT{} utiliser des clés canoniques dérivées des règles de l'Appendice A :
  \begin{itemize}
    \item \texttt{universes} par \texttt{(universe, proto)}.
    \item \texttt{flows} par \texttt{(src, dst, app\_proto)} en utilisant les chaînes du rapport \textbf{telles quelles} (\textbf{aucune normalisation} de casse, IPv6, formatage, etc.).
    \item \texttt{conflicts} par \texttt{(universe, sources)} où \texttt{sources} est la \textbf{liste canonique} d'identifiants de source triée \textbf{lexicographiquement} avant comparaison.
    \item \texttt{compliance} par \texttt{(protocol, violation\_id)}.
  \end{itemize}
  \item \textbf{Absent vs zéro :} les champs numériques optionnels absents en A ou B \DOIVENT{} être traités comme \textbf{inconnus} (afficher \texttt{N/A}) et \NEDOIVENTPAS{} être remplacés par zéro pour le calcul des deltas.
  \item \textbf{Égalité N/A :} si un champ est \texttt{N/A} dans \textbf{A et B}, il \NEDOITPAS{} être rapporté comme \enquote{changé}.
  \item \textbf{Présentation :} le viewer \DOIT{} classer les changements en \enquote{ajouté}, \enquote{retiré} ou \enquote{modifié}. Pour les valeurs numériques présentes dans A et B, il \PEUT{} afficher \texttt{B-A} en plus de \texttt{A \rightarrow B}.
\end{itemize}

\subsection{Invariants et stabilité UX}
\begin{itemize}
  \item \textbf{Ordre par défaut :} sans tri utilisateur, les listes \DOIVENT{} apparaître dans l'ordre canonique déterministe (Appendice A).
  \item \textbf{Tri stable :} lorsque le tri utilisateur est activé, il \DOIT{} être stable \textbf{par table/vue} (les égalités préservent l'ordre précédent).
  Les égalités sont définies par l'\textbf{égalité de clé canonique} pour la table donnée (voir clés de la vue compare ci-dessus).
  \item \textbf{Détails = vérité :} le panneau de détails \DOIT{} présenter des valeurs complètes, non tronquées ; la vue JSON brute \DOIT{} refléter le rapport chargé sans modification.
  \item \textbf{Troncature sûre :} les cellules de table \PEUVENT{} être tronquées pour la lisibilité, mais la valeur complète \DOIT{} rester accessible (infobulle et/ou détails).
  \item \textbf{Inconnus explicites :} les champs optionnels manquants \DOIVENT{} être affichés comme \texttt{N/A} (jamais silencieusement comme 0).
\end{itemize}

\section{Critères de validation (extrait)}

\subsection{Définition de fin v0.1}
Le MVP est considéré livré si :
\begin{enumerate}
  \item \texttt{liveshark pcap analyse --report out/report.json}\\
  \texttt{file.pcapng} fonctionne sur 3 captures.
  \item Art-Net et sACN sont décodés (univers, sources, fps).
  \item Le rapport JSON contient \texttt{conflicts[]} (détection auto).
  \item Aucun crash sur PCAP tronqué/corrompu.
\end{enumerate}

\subsection{Tests golden}
Format : \texttt{tests/golden/<nom>/\{input.pcapng, expected\_report.json,\\ metadata.toml\}}.
\texttt{metadata.toml} décrit l'intention du test, les assertions (ex. \texttt{fps\_min},
\texttt{compliance\_percentage}) et les
  règles de tolérance. Voir \texttt{AGENTS.md} \S9.4 pour le schéma.

\appendix
\section{Appendices (normatifs)}
\subsection{Appendice A --- Contrat du rapport JSON (v0.1)}
\subsubsection{Schéma minimal (champs et types)}
\begin{itemize}
  \item \texttt{report\_version} : entier (version de schéma ; n'est incrémentée qu'en cas de rupture de compatibilité ; les ajouts additifs de champs optionnels n'incrémentent pas la version).
  \item \texttt{tool.name} et \texttt{tool.version} : chaînes (identification de l'outil).
  \item \texttt{generated\_at} : chaîne, horodatage RFC3339.
  \item \texttt{input.path} : chaîne ; \texttt{input.bytes} : entier.
  \item \texttt{capture\_summary} : objet ou null (si indisponible).
  \item \texttt{universes[]}, \texttt{flows[]}, \texttt{conflicts[]} : tableaux (peuvent être vides en v0.1).
  \item \texttt{compliance[]} : tableau (peut être vide en v0.1).
  \item Les éléments de \texttt{universes[]} contiennent : \texttt{universe} (entier), \texttt{proto} (chaîne),\\
  \texttt{sources[]} (tableau d'objets avec \texttt{source\_ip}, \texttt{cid} optionnel,\\
  et \texttt{source\_name} optionnel ;\\
  \texttt{cid} est en hexadécimal minuscule, 32 caractères, sans séparateurs),\\
  \texttt{fps} (flottant ou null), \texttt{frames\_count} (entier), et des champs de métriques optionnels\\
  \texttt{loss\_packets}, \texttt{loss\_rate}, \texttt{burst\_count},\\
  \texttt{max\_burst\_len}, \texttt{jitter\_ms}, \texttt{dup\_packets}, \texttt{reordered\_packets}
  (omis si indisponibles).
  \item Les éléments de \texttt{flows[]} contiennent : \texttt{app\_proto} (chaîne), \texttt{src} (chaîne), \texttt{dst} (chaîne),
  et \texttt{pps}, \texttt{bps}, \texttt{iat\_jitter\_ms}, \texttt{max\_iat\_ms}, \texttt{pps\_peak\_1s}, \texttt{bps\_peak\_1s} optionnels (omis si indisponibles).
  \item Les éléments de \texttt{conflicts[]} sont définis dans l'Appendice C.
  \item Les éléments de \texttt{compliance[]} contiennent : \texttt{protocol} (chaîne),\\
  \texttt{compliance\_percentage}\\
  (flottant ; v0.1 utilise 100.0 comme valeur de remplacement),\\
  et \texttt{violations[]} (tableau d'objets avec : \texttt{id} (identifiant stable),\\
  \texttt{severity} (chaîne ; v0.1 utilise \texttt{warning} ou \texttt{error}),\\
  \texttt{message} (explication lisible), \texttt{count} (entier, nombre total d'occurrences sur la capture), et \texttt{examples[]} optionnel\\
  (tableau d'au plus 3 chaînes, chacune donnant un contexte concis tel que \texttt{"source IP:port @ timestamp"} ;\\
  les octets de charge utile ne sont pas requis).\\
  La liste d'exemples, lorsqu'elle est présente, \DOIT{} être dédupliquée, triée de façon stable et limitée à 3 pour garder des rapports compacts et déterministes. Les exemples sont illustratifs et n'affectent pas \texttt{count}.
\end{itemize}

\subsubsection{Identifiants de violations compliance (v0.1, non exhaustif)}
\begin{itemize}
  \item \texttt{LS-UDP-SLICE} : erreur de découpage UDP ; paquet ignoré.
  \item \texttt{LS-UDP-MISSING-NETWORK} : couche réseau manquante ; paquet ignoré.
  \item \texttt{LS-UDP-MISSING-PAYLOAD} : charge utile IP manquante ; paquet ignoré.
  \item \texttt{LS-UDP-TOO-SHORT} : charge utile UDP trop courte ; paquet ignoré.
  \item \texttt{LS-ARTNET-LENGTH} : longueur ArtDMX invalide (0 ou $> 512$) ; paquet ignoré.
  \item \texttt{LS-ARTNET-TOO-SHORT} : charge utile trop courte ; paquet ignoré.
  \item \texttt{LS-SACN-DMX-LENGTH} : longueur des données DMX sACN invalide ; paquet ignoré.
  \item \texttt{LS-SACN-TOO-SHORT} : charge utile trop courte ; paquet ignoré.
  \item \texttt{LS-ARTNET-UNIVERSE-ID} : identifiant d'univers Art-Net hors plage (valeur $> 0x7FFF$) ; paquet ignoré.
  \item \texttt{LS-SACN-START-CODE} : start code sACN différent de 0x00 ; paquet ignoré.
  \item \texttt{LS-SACN-PROPERTY-COUNT} : property value count sACN à 0 ou supérieur à 512 ; paquet ignoré.
\end{itemize}

\subsubsection{Règles de déterminisme}
\begin{itemize}
  \item \textbf{Ordonnancement stable :}
  \texttt{universes[]} triés par \texttt{universe} croissant puis \texttt{proto} croissant ;
  \texttt{sources[]} dans chaque univers triés par \texttt{source\_ip} croissant ;
  \texttt{flows[]} triés par \texttt{src} puis \texttt{dst} ;
  \texttt{conflicts[]} triés par \texttt{universe} puis \texttt{sources} (ordre lexicographique) ;
  \texttt{sources[]} dans chaque conflit triés par ordre lexicographique des identifiants de source ;
  \texttt{compliance[]} triés par \texttt{protocol}, puis \texttt{violations[]} par \texttt{id}.
  \item \textbf{Champs volatils :} seuls \texttt{generated\_at} (et optionnellement \texttt{input.path}) peuvent varier.
  \item \textbf{Flottants :} en v0.1, les valeurs flottantes sont sérialisées avec une précision suffisante pour garantir un JSON déterministe (minimum 6 chiffres significatifs). Des règles d'arrondi explicites pourront être définies pour certains champs.
  \item \textbf{RFC3339 :} \texttt{generated\_at}, \texttt{time\_start} et \texttt{time\_end} utilisent RFC3339.
\end{itemize}

\subsubsection{Exemple (minimal)}
\begin{verbatim}
{
  "report_version": 1,
  "tool": { "name": "liveshark", "version": "0.1.0" },
  "generated_at": "1970-01-01T00:00:00Z",
  "input": { "path": "capture.pcapng", "bytes": 123456 },
  "capture_summary": null,
  "universes": [],
  "flows": [],
  "conflicts": [],
  "compliance": []
}
\end{verbatim}

\subsubsection{Exemple (conflit)}
\begin{verbatim}
{
  "universe": 1,
  "sources": [
    "sacn:cid:11223344556677889900aabbccddeeff",
    "artnet:192.168.0.2:6454"
  ],
  "overlap_duration_s": 3.5,
  "affected_channels": [],
  "severity": "medium",
  "conflict_score": 3.5
}
\end{verbatim}

\subsection{Appendice B --- Contrat de reconstruction des trames DMX (v0.1)}
\subsubsection{Définition canonique d'une trame DMX}
Une trame DMX reconstruite est définie par :
\begin{itemize}
  \item \textbf{universe} : identifiant d'univers 16 bits.
  \item \textbf{timestamp} : horodatage de capture (timestamp du paquet).
  \item \textbf{source\_id} : identité de source stable (voir Appendice C).
  \item \textbf{protocol} : \texttt{artnet} ou \texttt{sacn}.
  \item \textbf{slots[512]} : 512 valeurs DMX (0--255).
\end{itemize}

\subsubsection{Normalisation des univers}
L'univers canonique est l'entier 16 bits décodé depuis la charge utile du protocole. Pour Art-Net, il est calculé à partir
des champs ArtDMX \texttt{Net} (octet de poids fort) et \texttt{SubUni} (octet de poids faible), avec
\texttt{universe\_id = 256 * net + subuni} (0..32767). \texttt{Net} et \texttt{SubUni} sont des champs d'un octet ;
\texttt{universe\_id} utilise \texttt{Net} comme octet de poids fort et \texttt{SubUni} comme octet de poids faible
(ce n'est pas un champ 16 bits en little-endian). Pour sACN, c'est le champ \texttt{universe} en big-endian de la couche
de framing. Le rapport utilise cette valeur canonique ; un même univers signifie des valeurs numériques identiques entre
protocoles.

\subsubsection{Règles minimales de reconstruction}
\begin{itemize}
  \item Les trames sont reconstruites par univers, par source et par protocole,  à partir de charges utiles valides.
  \item Avant la première trame observée pour un (univers, source, protocole), les valeurs de slots sont à 0 par défaut.
  \item Si une charge utile fournit moins de 512 slots, les slots manquants conservent la dernière valeur connue pour cet (univers, source, protocole).
  \item Les trames reconstruites exposent toujours 512 slots.
  \item Les trames hors ordre sont acceptées ; la reconstruction et les métriques sont heuristiques.
  \item Le fps compte les trames validées et associées à un univers.
\end{itemize}

\subsection{Appendice C --- Contrat de détection de conflits (v0.1)}
\subsubsection{Identité de source}
\begin{itemize}
  \item \textbf{sACN :} \texttt{sacn:cid:<CID>} lorsque le CID est présent ; sinon \texttt{sacn:<ip>:<port>}.
  \item \textbf{Art-Net :} \texttt{artnet:<ip>:<port>}.
\end{itemize}
\textbf{Format du CID :} hexadécimal minuscule, 32 caractères, sans séparateurs.

\subsubsection{Définition du chevauchement}
Un conflit est défini comme : même univers, au moins deux sources, et chevauchement $> 1.0$ s.
Le chevauchement est calculé à partir des intervalles \texttt{[first\_ts, last\_ts]} par source et de leur intersection.
En v0.1, la détection de conflit est une approximation prudente basée sur le chevauchement temporel ; tout chevauchement
$> 1.0$ s déclenche un conflit, même si les sources ne concurrencent pas activement les mêmes canaux au même moment.
Le taux de faux positifs n'est pas quantifié en v0.1 ; les conflits sont des signaux à investiguer.
\texttt{affected\_channels[]} est calculé au mieux et peut être vide lorsque des indices par canal ne peuvent pas être
dérivés de la fenêtre de chevauchement.

\subsubsection{Champs d'un conflit}
\begin{itemize}
  \item \texttt{universe} (entier)
  \item \texttt{sources[]} (liste d'identifiants de source)
  \item \texttt{overlap\_duration\_s} (secondes, flottant)
    \item \texttt{affected\_channels[]} (liste d'entiers ; calcul au mieux sur la fenêtre de chevauchement, peut être vide en v0.1)
  \item \texttt{severity} (chaîne)
  \item \texttt{conflict\_score} (flottant)
\end{itemize}
En v0.1, \texttt{severity} est fixé à \texttt{"medium"} et \texttt{conflict\_score} est égal à \texttt{overlap\_duration\_s}.
Optionnel (prévu, non normatif) : \texttt{first\_seen}, \texttt{last\_seen} et \texttt{protocols[]}.

\subsection{Appendice D --- Définitions des métriques (v0.1)}
\begin{itemize}
  \item \textbf{pps/bps :} paquets/octets par seconde en moyenne sur l'intervalle actif du flux $[t_{first}, t_{last}]$. Unités paquets/s et octets/s. Omettre si moins de deux paquets horodatés existent ou si la durée active est indisponible. (Rapporté dans \texttt{flows[]}.)
  \item \textbf{fps (univers) :} trames DMX reconstruites par seconde sur une fenêtre glissante de 5.0 s ; unité trames/s.
  \item \textbf{gigue (IAT) :} moyenne des variations absolues entre temps d'arrivée successifs sur une fenêtre glissante de 10.0 s : $\text{mean}(|IAT_i - IAT_{i-1}|)$. L'unité est la milliseconde pour \texttt{iat\_jitter\_ms} et \texttt{jitter\_ms}. La valeur rapportée est le pic (maximum) sur l'ensemble des fenêtres.
  \item \textbf{perte (observée) :} pour les sources avec numéros de séquence fiables (v0.1 : sACN), la perte est la somme des trous de séquence observés sur une fenêtre glissante de 10.0 s ;\\
  \texttt{loss\_rate} est \texttt{loss\_packets / (loss\_packets + frames\_count)}\\
  pour les trames suivies par séquence. Si les numéros de séquence sont indisponibles, les champs de perte \DOIT{} être omis.
  \item \textbf{rafales :} pour les sources avec numéros de séquence fiables (v0.1 : sACN), \texttt{burst\_count} est le nombre de rafales de pertes sur une fenêtre glissante de 10.0 s ; \texttt{max\_burst\_len} est la
  longueur maximale de rafale observée dans la même fenêtre. Si les numéros de séquence sont indisponibles, les champs de rafales \DOIT{} être omis.
\end{itemize}

\subsection{Appendice D.1 --- Métriques diagnostiques supplémentaires (additives)}
\begin{itemize}
  \item \textbf{max\_iat\_ms :} par flux, maximum des intervalles d'arrivée $\max(t_i - t_{i-1})$ sur toute la capture. Unité : millisecondes, entier arrondi au plus proche. Omettre si moins de deux paquets horodatés existent.
  \item \textbf{pps\_peak\_1s / bps\_peak\_1s :} par flux, pics de charge (paquets/s et octets/s) sur une fenêtre glissante de 1.0 s, avec règle d'inclusion $[t-1.0, t]$. Reporter le maximum des comptes de fenêtre en entier. Omettre si moins de deux paquets horodatés existent ou si la durée couverte est $< 1.0$ s.
  \item \textbf{dup\_packets / reordered\_packets :} par univers, compteurs agrégés sur les sources sACN avec numéros de séquence. \texttt{dup\_packets} s'incrémente quand $\texttt{seq} = \texttt{seq\_prev}$. \texttt{reordered\_packets} s'incrémente quand le delta modulo 256 $\Delta = (\texttt{seq} - \texttt{seq\_prev}) \bmod 256$ est dans $[128, 255]$. Le wrap-around (ex. 254, 255, 0, 1) est dans l'ordre. Omettre si aucun numéro de séquence n'est disponible.
\end{itemize}

\section{Licence}
Le code est sous licence \textbf{MIT OR Apache-2.0}. La documentation et les spécifications sont sous licence \textbf{CC-BY-4.0}.
Les fichiers PDF sont des artefacts de compilation générés depuis les sources \texttt{.tex} et \textbf{ne doivent pas être versionnés} dans le dépôt.

\section{Références normatives}
\begin{adjustbox}{max width=\linewidth}
\begin{tabularx}{\linewidth}{@{}l X@{}}
\toprule
\textbf{Référence} & \textbf{Titre} \\
\midrule
RFC 2119 & Key words for use in RFCs to Indicate Requirement Levels \\
RFC 8174 & Ambiguity of Uppercase vs Lowercase\\ in RFC 2119 Key Words \\
ANSI E1.31-2018 & Streaming ACN (sACN) \\
Art-Net 4 & Art-Net 4 Specification\\ (Protocol Release) \\
\bottomrule
\end{tabularx}
\end{adjustbox}

\nocite{rfc2119,rfc8174,e1312018,artnet4}
\printbibliography

\end{document}
