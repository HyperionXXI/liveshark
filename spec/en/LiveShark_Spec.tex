\documentclass[11pt]{article}

\input{../common/liveshark-style.tex}
\input{../common/liveshark-macros.tex}

\usepackage{csquotes}
\usepackage{biblatex}
\addbibresource{../common/references.bib}

\title{\sffamily\bfseries\color{LSBlue}LiveShark\\\large Specification (Printable PDF) v0.1}
\author{\sffamily Florian Keller}
\date{\sffamily Draft - \today\\\small\textsf{Authoritative language: EN}}

\begin{document}
\maketitle
\vspace{0.6em}

\begin{tcolorbox}
\textbf{Scope.} LiveShark is a \textbf{passive} analyzer for show-control networking (Art-Net, sACN). It focuses on
\textbf{offline PCAP analysis} with \textbf{DMX frame reconstruction}, \textbf{automatic conflict detection},
and \textbf{reproducible reports}.\\
\textbf{Audience.} Designed to be readable by \textbf{non-software specialists} (lighting technicians, integrators, QA).
Planned \textbf{follow mode} enables near-real-time analysis of a capture file that is still being written by an external tool.\\
The ideal user interface is a well-designed \textbf{GUI}; the \textbf{CLI} remains scriptable and produces the same report data.
\end{tcolorbox}

\newpage
\tableofcontents
\newpage

\section{Terminology and conventions}

\subsection{Authoritative version and translation policy}
\textbf{Authoritative version (prevails).} The English specification in \texttt{spec/en} is the \emph{authoritative}
version: in case of discrepancy or incomplete translation, \textbf{the English version prevails}.\\
\textbf{French translation (informational).} A French translation may exist in \texttt{spec/fr}. It is provided as a convenience and
\textbf{may lag behind}. When differences exist, the authoritative version prevails.

\subsection{Normative keywords}
The key words \MUST, \MUSTNOT, \SHOULD, \SHOULDNOT, and \MAY{} are to be interpreted as described in BCP 14
(RFC 2119 and RFC 8174). Only \textbf{UPPERCASE} usage is normative.

\subsection{Implementation language note}
LiveShark is implemented in \textbf{Rust} to balance \textbf{memory safety}, \textbf{performance}, and \textbf{cross-platform}
delivery (Windows, macOS, Linux) with a modern toolchain. This is an engineering choice for v0.1 and does not preclude
future components from using other languages where justified.
Rust code SHOULD follow the standard Rust style guide: \texttt{https://doc.rust-lang.org/style-guide/}.


\subsection{Term note: \enquote{Live}}
In the project name, \enquote{Live} refers to \textbf{live entertainment / show control} (lighting networks), not to a guarantee
of real-time capture capability. Real-time capture is optional and may be introduced in later releases.
Near-real-time diagnostic can be achieved via follow mode without requiring native live capture.

\subsection{Core terms}
\begin{adjustbox}{max width=\linewidth}
\begin{tabularx}{\linewidth}{@{}l >{\raggedright\arraybackslash}X@{}}
\toprule
\textbf{Term} & \textbf{Meaning} \\
\midrule
Packet & Network packet as captured in PCAP/PCAPNG. \\
Protocol message & Decoded application-layer unit (e.g., ArtDMX,\\ sACN Data Packet). \\
DMX frame & Reconstructed DMX512 state (512 slots) for a universe at a given time. \\
Universe & Logical group of up to 512 DMX slots. \\
Source & Emitter identified by IP and, if applicable, protocol identity (e.g., sACN CID). \\
Flow & Unidirectional tuple (proto, src ip:port, dst ip:port). \\
\bottomrule
\end{tabularx}
\end{adjustbox}

\subsection{Acronyms}
\begin{adjustbox}{max width=\linewidth}
\begin{tabularx}{\linewidth}{@{}l >{\raggedright\arraybackslash}X@{}}
\toprule
\textbf{Acronym} & \textbf{Expanded form} \\
\midrule
ACN & Architecture for Control Networks \\
AES67 & High-performance audio-over-IP interoperability standard \\
ArtDMX & Art-Net DMX data packet \\
Art-Net & Art-Net lighting control protocol \\
ANSI & American National Standards Institute \\
ARP & Address Resolution Protocol \\
BCP & Best Current Practice \\
CC-BY-4.0 & Creative Commons Attribution 4.0 International \\
CID & Component Identifier (sACN source identifier) \\
CI & Continuous integration \\
CLI & Command-line interface \\
DHCP & Dynamic Host Configuration Protocol \\
DNS & Domain Name System \\
DMX & Digital Multiplex (DMX512 / DMX512-A) \\
DMX512 & Digital Multiplex 512 \\
DoD & Definition of Done \\
FPS / PPS / BPS & Frames / Packets / Bytes per second \\
GUI & Graphical user interface \\
IGMP & Internet Group Management Protocol \\
IP & Internet Protocol \\
IPv6 & Internet Protocol version 6 \\
JSON & JavaScript Object Notation \\
MIT & Massachusetts Institute of Technology (license) \\
mDNS & Multicast DNS \\
MVP & Minimum Viable Product \\
PCAP & Packet Capture file format \\
PCAPNG & PCAP Next Generation file format \\
PDF & Portable Document Format \\
QA & Quality assurance \\
RFC & Request for Comments \\
RTP & Real-time Transport Protocol \\
sACN & Streaming ACN (ANSI E1.31) \\
UDP & User Datagram Protocol \\
\bottomrule
\end{tabularx}
\end{adjustbox}

\section{What LiveShark is (and is not)}

\subsection{Goals}
\begin{itemize}
  \item Offline analysis of PCAP/PCAPNG for Art-Net and sACN.
  \item DMX frame reconstruction (512 slots) and metrics (fps, pps/bps, jitter, loss, bursts).
  \item Automatic detection of \textbf{conflicts} (multiple sources on same universe with overlap).
  \item Versioned, reproducible JSON reports for tickets, post-mortem, QA and CI.
\end{itemize}
See Appendices A--D for the normative contracts (report, frames, conflicts, metrics).

\paragraph{Capture input (no Wireshark required).}
LiveShark \MUSTNOT{} require the Wireshark GUI\\ application to operate.
For v0.1, captures are provided as PCAP/PCAPNG files produced by standard tools (e.g., \texttt{tcpdump} on Linux,\\
\texttt{pktmon} on Windows, or any capture tool that exports PCAP/PCAPNG).
Live capture is a future objective and \MAY{} be added later via libpcap/Npcap (without changing the report schema).



\subsection{Offline-first strategy (product intent)}
LiveShark is designed as an \emph{offline-first} analyzer:\\
early releases focus on post-mortem analysis of PCAP/PCAPNG captures
to maximize robustness, reproducibility, and ease of support. This is a deliberate engineering strategy, not a product limitation.
Live capture / online analysis is an explicit future objective and \MAY{} be implemented once the offline core is validated.

\textbf{Forward compatibility.} The core analysis pipeline \MUST{} be architected so that packet input can come from either:
(a) a file reader (PCAP/PCAPNG), or (b) a live capture source (future). No offline-only assumption \MUST{} be embedded in the
domain model (frames, conflicts, reports).

Follow mode is the pragmatic path for reliable diagnostics during show preparation and during the show: it analyzes a capture
file as it grows, without requiring native capture on day one.

LiveShark may emit \emph{probable-cause hints} only as heuristics and separate from measured metrics. Any hint \MUST{} be
justified by observable indicators (loss patterns, jitter, bursts, timing asymmetries) and \MUSTNOT{} be presented as a certain
cause. Robust loss localization may require multiple capture points (for example, before and after a wireless segment) and is
reported only when feasible based on the available evidence.



\subsection{Non-goals}
\begin{itemize}
  \item LiveShark is \textbf{not} a general-purpose packet analyzer (it does not replace Wireshark).
  \item LiveShark is \textbf{passive} by design: it does not transmit or inject traffic.
  \item ``Laser over IP'' starts as \textbf{generic UDP flow metrics only}; laser frame reconstruction is out of scope for v0.1.
\end{itemize}

\subsection{Optional extensions (non-normative register)}
LiveShark is designed for diagnostics. Extensions must improve actionable diagnosis (loss, jitter, bursts, conflicts, multi-source) and must remain reproducible (same input $\rightarrow$ same output).
These candidates are non-normative and not part of the v0.1 scope.

Each extension declares its support level:
\begin{itemize}
  \item \textbf{Flow level:} network-level metrics without payload semantics.
  \item \textbf{Message/Frame level:} structured decoding with a stable domain model.
\end{itemize}

LiveShark may emit \emph{probable-cause hints} only as heuristics. Such hints must be justified by observable patterns and must never be presented as certain causes.

  \begin{itemize}
    \item \textbf{OSC (Message):} control-message timeline; correlation with DMX/network anomalies.
    \item \textbf{RTP-based protocols (Message):} sequence gaps, jitter, reordering; basis for health checks (e.g., AES67).
    \item \textbf{Network infrastructure (Flow):} IGMP/mDNS/DHCP/ARP/DNS patterns; multicast/discovery/addressing issues.
  \end{itemize}

\section{Architecture (conceptual)}
\begin{figure}[H]
\centering
\begin{adjustbox}{max width=\linewidth}
\input{../common/figures/dataflow.tex}
\end{adjustbox}
\caption{Conceptual offline analysis pipeline (high level).}
\textit{Note:} The pipeline currently accepts (v0.1) only PCAP/PCAPNG files. Live capture input is a future objective (v0.3+),
aligned with the input abstraction requirement in P0.
\end{figure}

\section{Metrics (defaults)}
Unless otherwise stated:
\begin{itemize}
  \item \textbf{fps window:} 5.0 s sliding window
  \item \textbf{jitter window:} 10.0 s sliding window
  \item \textbf{peak window:} 1.0 s sliding window (for \texttt{pps\_peak\_1s} / \texttt{bps\_peak\_1s})
\end{itemize}
Sliding windows include packets with timestamps in $[t - W, t]$ (inclusive).

\paragraph{Windowed metric semantics (v0.1).}
Unless explicitly stated otherwise, windowed metrics report the value for the \textbf{last} window ending at the last observed timestamp. This applies to \texttt{fps}, \texttt{loss\_packets}, \texttt{loss\_rate}, \texttt{burst\_count}, and \texttt{max\_burst\_len}. Peak metrics (e.g., \texttt{pps\_peak\_1s} / \texttt{bps\_peak\_1s} and IAT jitter) report the \textbf{maximum} over all windows.

\subsection{Metrics definitions (minimal)}

\paragraph{sACN modulo-256 sequence delta (baseline definition).}
For sACN flows, packet sequence numbers are 8-bit counters. Let the modulo-256 delta be $\Delta = (\texttt{seq} - \texttt{seq\_prev}) \bmod 256$, where $\texttt{seq\_prev}$ is the sequence number of the previous packet from the same source. The delta determines packet ordering classification:
\begin{itemize}
  \item If $\Delta = 0$: duplicate packet (same sequence as prior).
  \item If $\Delta = 1$: in-order packet.
  \item If $\Delta \in [2, 127]$: indicates gap in sequence; missing count is $(\Delta - 1)$.
  \item If $\Delta \in [128, 255]$ (backward half-range): packet is reordered; \textbf{does not} contribute to loss.
  \item Wrap-around (e.g., $\ldots, 254, 255, 0, 1, \ldots$): treated as in-order.
\end{itemize}

\paragraph{Minimal metrics.}
\begin{itemize}
  \item \textbf{pps/bps:} packets/bytes per second averaged over the flow active interval $[t_{first}, t_{last}]$. Units are packets/s and bytes/s. Omit if fewer than two timestamped packets exist, if $t_{last} == t_{first}$, or if the active duration is unavailable. (Reported in \texttt{flows[]}.)
  \item \textbf{fps (universe):} reconstructed DMX frames per second over a 5.0 s sliding window; unit is frames/s. The reported value is the rate over the last 5.0 s window ending at the last observed timestamp.
  \item \textbf{IAT jitter (diagnostic):} mean absolute variation between consecutive inter-arrival times over a 10.0 s sliding window: $\text{mean}(|IAT_i - IAT_{i-1}|)$. Unit is milliseconds for \texttt{iat\_jitter\_ms} and \texttt{jitter\_ms}. The reported value is the peak (maximum) over all windows.
  \item \textbf{loss (observed):} when reliable protocol sequence numbers exist (v0.1: sACN), loss is reported as observed sequence gaps at the capture point. For sACN, gaps are computed per source using the modulo-256 delta rule above; only $\Delta \in [2,127]$ contributes missing packets as $(\Delta-1)$. In v0.1, loss \MUST{} be reported only when sequence numbers exist; otherwise loss fields are omitted. This does not guarantee loss at the receiver.
\end{itemize}
Optional metrics are omitted when not computable; absence does not imply zero.
See Appendix D for operational definitions and units.

\paragraph{Additional diagnostic metrics (additive)}
These fields are optional additions; additive fields \MUSTNOT{} bump \texttt{report\_version}.
\begin{itemize}
  \item \textbf{max\_iat\_ms (flows):} per UDP flow, maximum observed inter-arrival time $\max(t_i - t_{i-1})$ over the capture. Unit: milliseconds, integer rounded to nearest. Omit if fewer than two packets with timestamps exist for the flow.
  \item \textbf{pps\_peak\_1s / bps\_peak\_1s (flows):} per UDP flow, peak packets/s and bytes/s over a 1.0 s \emph{sliding} window. Window rule: include packets with timestamps in $[t-1.0, t]$ (inclusive of both ends). Report the maximum window count as an integer. Omit if the flow has fewer than two packets with timestamps or the covered duration is $< 1.0$ s.
  \item \textbf{dup\_packets / reordered\_packets (sACN universes):} per universe, counts are computed \textbf{per sACN source (CID)} in capture-time order and summed. For each source, let the modulo-256 delta be $\Delta = (\texttt{seq} - \texttt{seq\_prev}) \bmod 256$. If $\Delta = 0$, increment \texttt{dup\_packets}. If $\Delta = 1$, the packet is in-order. If $\Delta \in [2, 127]$, it indicates missing packets and contributes $(\Delta - 1)$ to the observed loss count. If $\Delta \in [128, 255]$ (backward half-range), increment \texttt{reordered\_packets}; backward-half deltas \textbf{do not} contribute to loss. Wrap-around (e.g., 254, 255, 0, 1) is in-order. Omit these fields when no sequence numbers are available.
\end{itemize}

\subsection{Compatibility and consumer contract}
Additions to the JSON report are non-breaking: consumers \MUST{} ignore unknown fields.
Optional metrics are omitted (absent) when not computable; absence does not mean zero.
\texttt{report\_version} indicates the base schema, and additive fields do not necessarily require a version bump when the rules above are respected.

In v0.1, loss is reported only when protocol sequence numbers exist (e.g., sACN); it is never inferred for Art-Net.

\section{Contractual requirements (extract)}
This document is a bootstrap spec: requirements are intentionally minimal at project start.

\subsection{Priority P0 (MVP foundations)}
\begin{reqbox}{LS-ARCH-001}{P0}{}
The core \MUST{} expose a packet/event input abstraction so that analysis can be driven by:
(a) a PCAP/PCAPNG file reader (v0.1), and (b) a live capture source (future), without changing the domain model or report schema.
\end{reqbox}

\begin{reqbox}{LS-PROD-001}{P0}{}
LiveShark \MUSTNOT{} require the Wireshark GUI application. It \MUST{} accept PCAP/PCAPNG files produced by standard capture tools.
\end{reqbox}

\begin{reqbox}{LS-FR-001}{P0}{}
LiveShark \MUST{} ingest PCAP/PCAPNG files and enumerate UDP flows.
\end{reqbox}

\begin{reqbox}{LS-FR-010}{P0}{}
LiveShark \MUST{} decode Art-Net ArtDMX and reconstruct DMX frames (512 slots) per universe.
\end{reqbox}

\begin{reqbox}{LS-FR-011}{P0}{}
LiveShark \MUST{} decode sACN (E1.31) DMX data packets and reconstruct DMX frames per universe.
\end{reqbox}

\subsection{Priority P1 (critical differentiators)}
\begin{reqbox}{LS-CONF-001}{P1}{}
LiveShark \MUST{} detect concurrent sources: two or more sources emitting on the same universe with overlap $> 1.0$ s.
\end{reqbox}

\begin{reqbox}{LS-REP-001}{P1}{}
LiveShark \MUST{} generate a versioned JSON report containing at least: capture summary, universes (with per-universe sources),
flows, and conflicts.
\end{reqbox}

\begin{reqbox}{LS-REP-002}{P1}{}
The JSON report \MUST{} be deterministic: list ordering is stable and all volatile fields are explicitly defined.
\end{reqbox}

\begin{reqbox}{LS-REP-003}{P1}{}
The JSON report \MUST{} include the minimal schema fields and types defined in Appendix A (v0.1).
\end{reqbox}

\begin{reqbox}{LS-REP-004}{P1}{}
Conflict records in the JSON report \MUST{} follow the structure defined in Appendix C.
\end{reqbox}

\begin{reqbox}{LS-FR-012}{P0}{}
LiveShark \MUST{} use a canonical reconstructed DMX frame definition (fields + 512 slots) as defined in Appendix B.
\end{reqbox}

\begin{reqbox}{LS-FR-013}{P1}{}
LiveShark \MUST{} follow the frame reconstruction rules and fps counting rules defined in Appendix B.
\end{reqbox}

\begin{reqbox}{LS-CONF-002}{P1}{}
LiveShark \MUST{} use the source identity definition for conflicts defined in Appendix C.
\end{reqbox}

\begin{reqbox}{LS-CONF-003}{P1}{}
LiveShark \MUST{} compute overlap for conflicts using the definition in Appendix C.
\end{reqbox}

\begin{reqbox}{LS-CONF-010}{P1}{}
LiveShark \MUST{} use the source identity definition for conflict detection defined in Appendix C (CID + fallback).
\end{reqbox}

\begin{reqbox}{LS-CONF-011}{P1}{}
LiveShark \MUST{} compute conflict overlap using capture timestamps and the threshold defined in Appendix C (v0.1).
\end{reqbox}

\begin{reqbox}{LS-CONF-012}{P1}{}
Conflict records \MUST{} include the required fields defined in Appendix C (v0.1).
\end{reqbox}

\begin{reqbox}{LS-MET-001}{P1}{}
LiveShark \MUST{} compute and report pps/bps/fps/jitter as defined in Appendix D (v0.1).
\end{reqbox}
\section{Known limitations (v0.1)}
\begin{itemize}
  \item \textbf{Compliance percentage} is a placeholder (reported as 100.0 in v0.1) and \MUSTNOT{} be interpreted as a real compliance score. Consumers \MUST{} rely on \texttt{violations[]} as the source of truth.
  \item \textbf{Conflict detection} uses time overlap only and may produce false positives when sources are active on different channels. The false-positive rate is not quantified in v0.1; conflicts are signals to investigate.
  \item \textbf{sACN validation} drops packets with non-zero start code or invalid property value count (the count includes the start code; valid range is 1..=513).
\end{itemize}
\section{Planned scope (v0.2, non-normative)}
This section summarizes intended v0.2 direction. It does not change the v0.1 contract.
\begin{itemize}
  \item \textbf{Viewer timeline:} time-based navigation for universes, flows, and conflicts using explicit report fields only.
  \item \textbf{Compare mode:} deterministic A/B diff using canonical ordering and keys from Appendix A; absent is treated as \texttt{N/A}, not zero.
  \item \textbf{Viewer performance:} remain responsive on large reports (table + details).
  \item \textbf{Offline-only:} still file-based analysis, no native live capture.
  \item \textbf{Schema stability:} additive fields remain optional; no breaking changes to v0.1 consumers.
\end{itemize}

\section{Planned scope (v0.3+, non-normative)}
\begin{itemize}
  \item \textbf{sACN advanced signals:} expose sync, discovery, and priority (including per-address) without inferring root causes.
  \item \textbf{Network symptoms:} report observable multicast/IGMP/burst patterns without claiming device fault.
  \item \textbf{Security presence:} flag ssACN when detected (presence only, no threat inference).
  \item \textbf{RDMnet visibility:} detect presence and participants (visibility only, no device control).
\end{itemize}
\section{Operational viewer contract (v0.2)}
\textbf{Status.} This section defines the \textbf{operational contract} for the v0.2 GUI (timeline + compare). It is
\textbf{normative for v0.2} and informational for v0.1.

\subsection{Inputs and safety}
\begin{itemize}
  \item \textbf{Inputs:} the viewer \MUST{} accept one report (\enquote{A}) for timeline view, and \MAY{} accept a second report (\enquote{B}) for compare view.
  \item \textbf{Read-only:} the viewer \MUSTNOT{} modify the input files.
  \item \textbf{Offline-only:} the viewer \MUSTNOT{} perform network requests. It \MUST{} run from local files and remain zero-deps.
  \item \textbf{No evaluation of embedded content:} JSON is treated as data only; the viewer \MUSTNOT{} evaluate, interpret, or execute embedded content.
\end{itemize}

\subsection{Timeline view (definition)}
\begin{itemize}
  \item \textbf{Time bounds:} the timeline \MUST{} use capture time bounds from \texttt{capture\_summary.time\_start} and \texttt{capture\_summary.time\_end} (RFC3339).
  Bounds are \textbf{inclusive}. If \texttt{time\_start == time\_end}, the viewer \MUST{} display a \textbf{zero-length} timeline (single instant) and \MUSTNOT{} invent a duration.
  If \texttt{capture\_summary} or its bounds are missing, the viewer \MUST{} show a clear \enquote{Timeline unavailable} state and \MUSTNOT{} guess bounds.
  \item \textbf{Universe rows:} a universe row is identified by the canonical key \texttt{(universe, proto)} (aligned with Appendix A ordering rules). It \MUST{} be selectable and linked to the same universe in the table/details views.
  \item \textbf{Activity interval (v0.2 fields):} for each universe row, the report \SHOULD{} provide additive fields \texttt{first\_seen} and \texttt{last\_seen} (RFC3339)
  indicating the first/last observed valid message contributing to that universe. These fields are \textbf{optional} and \textbf{additive} and \MUSTNOT{} change \texttt{report\_version}.
  If absent, the viewer \MUST{} display the interval as \texttt{N/A} and \MUSTNOT{} infer it.
  \item \textbf{Conflicts on timeline (v0.2 fields):} conflict intervals \SHOULD{} be represented when additive fields \texttt{conflicts[].first\_seen} and \texttt{conflicts[].last\_seen} (RFC3339) are present.
  If absent, conflicts \MUST{} remain visible in the conflict list/details but \MUSTNOT{} be placed on the timeline.
  \item \textbf{No inference:} the timeline \MUST{} visualize only measured/explicit fields from the report. It \MUSTNOT{} create new events, and it \MUSTNOT{} claim root causes.
\end{itemize}

\subsection{Compare view (definition)}
\begin{itemize}
  \item \textbf{No inference (reminder):} compare mode \MUST{} report only deltas of explicit fields; it \MUSTNOT{} infer missing metrics or claim causes.
  \item \textbf{Deterministic diff:} given the same input pair (A,B), the compare view \MUST{} produce the same deltas (no randomness, stable ordering).
  \item \textbf{Keys and ordering:} comparisons \MUST{} use canonical keys derived from Appendix A ordering rules:
  \begin{itemize}
    \item \texttt{universes} by \texttt{(universe, proto)}.
    \item \texttt{flows} by \texttt{(src, dst, app\_proto)} using the report strings \textbf{as-is} (\textbf{no normalization} of case, IPv6, formatting, etc.).
    \item \texttt{conflicts} by \texttt{(universe, sources)} where \texttt{sources} is the \textbf{canonical list} of source identifiers sorted \textbf{lexicographically} before comparison.
    \item \texttt{compliance} by \texttt{(protocol, violation\_id)}.
  \end{itemize}
  \item \textbf{Absent vs zero:} optional numeric fields absent in A or B \MUST{} be treated as \textbf{unknown} (display \texttt{N/A}) and \MUSTNOT{} be substituted with zero for delta computation.
  \item \textbf{N/A equality:} if a field is \texttt{N/A} in \textbf{both} A and B, it \MUSTNOT{} be reported as \enquote{changed}.
  \item \textbf{Presentation:} the viewer \MUST{} classify changes as \enquote{added}, \enquote{removed}, or \enquote{changed}. For numeric values present in both A and B, it \MAY{} display \texttt{B-A} in addition to \texttt{A \textrightarrow B}.
\end{itemize}

\subsection{Invariants and UX stability}
\begin{itemize}
  \item \textbf{Default ordering:} without user sorting, lists \MUST{} appear in the canonical deterministic order (Appendix A).
  \item \textbf{Stable sort:} when user sorting is enabled, it \MUST{} be stable \textbf{per table/view} (ties preserve previous order).
  Ties are defined by \textbf{canonical key equality} for the given table (as defined in the Compare view keys above).
  \item \textbf{Details are authoritative:} the details panel \MUST{} present full, untruncated values for the selected item; the raw JSON view \MUST{} reflect the loaded report without modification.
  \item \textbf{Truncation safety:} table cells \MAY{} be truncated for readability, but the full value \MUST{} remain accessible (tooltip and/or details).
  \item \textbf{Explicit unknowns:} missing optional fields \MUST{} be shown as \texttt{N/A} (never silently as 0).
\end{itemize}
\section{Validation criteria (extract)}

\subsection{Definition of Done v0.1}
The MVP is considered delivered if:
\begin{enumerate}
  \item \texttt{liveshark pcap analyze --report out/report.json file.pcapng}\\
  runs successfully on 3 captures. The CLI also accepts \texttt{analyse} as an alias.
  \item Art-Net and sACN are decoded (universes, sources, fps).
  \item The JSON report contains \texttt{conflicts[]} (automatic detection).
  \item No crash occurs on truncated/corrupted PCAPs.
\end{enumerate}

\subsection{Validation checklist (report contract)}
\begin{enumerate}
  \item Report includes \texttt{report\_version}, \texttt{tool}, \texttt{generated\_at}, \texttt{input}, and sections\\
  \texttt{capture\_summary}, \texttt{universes[]}, \texttt{flows[]}, \texttt{conflicts[]}, \texttt{compliance[]}.
  \item Deterministic ordering rules are applied (Appendix A).
  \item At least 4 golden tests: \texttt{artnet}, \texttt{artnet\_conflict}, \texttt{sacn}, \texttt{sacn\_conflict}.
  \item Volatile fields (\texttt{generated\_at}, and optionally \texttt{input.path}) are normalized in golden tests.
\end{enumerate}

\subsection{Golden tests}
Format: \texttt{tests/golden/<name>/\{input.pcapng, expected\_report.json,\\ metadata.toml\}}.
\texttt{metadata.toml} documents test intent, assertions (e.g., \texttt{fps\_min}, \texttt{compliance\_percentage}), and tolerance
rules. See \texttt{AGENTS.md} \S9.4 for the schema.

\appendix
\section{Appendices (Normative)}
\subsection{Appendix A --- JSON report contract (v0.1)}
\subsubsection{Minimal schema (fields and types)}
\begin{itemize}
  \item \texttt{report\_version}: integer (schema version). Additive optional fields \MUSTNOT{} bump this value.
  \item \texttt{tool.name} and \texttt{tool.version}: strings (tool identification).
  \item \texttt{generated\_at}: string, RFC3339 timestamp.
  \item \texttt{input.path}: string; \texttt{input.bytes}: integer.
  \item \texttt{capture\_summary}: object or null (when unavailable). When present, it \MUST{} include\\
  \texttt{packets\_total} (integer), and \texttt{time\_start}/\texttt{time\_end} as RFC3339 UTC timestamps with \texttt{Z} when known.
  \item \texttt{universes[]}, \texttt{flows[]}, \texttt{conflicts[]}: arrays (may be empty in v0.1).
  \item \texttt{compliance[]}: array (may be empty in v0.1).
  \item \texttt{universes[]} elements contain: \texttt{universe} (integer), \texttt{proto} (string),
  \texttt{sources[]} (array of objects with \texttt{source\_ip}, optional \texttt{cid} and \texttt{source\_name};
    \texttt{cid} is lowercase hex, 32 characters, no separators; v0.2 adds optional \texttt{source\_id} field, see Appendix D),
    \texttt{fps} (float or null), \texttt{frames\_count} (integer), and optional metric fields\\
    \texttt{loss\_packets}, \texttt{loss\_rate}, \texttt{burst\_count}, \texttt{max\_burst\_len}, \texttt{jitter\_ms},\\
    \texttt{dup\_packets}, \texttt{reordered\_packets} (omitted when unavailable)
  (omitted when unavailable).
  \item \texttt{flows[]} elements contain: \texttt{app\_proto} (string), \texttt{src} (string), \texttt{dst} (string),
  and optional \texttt{pps}, \texttt{bps}, \texttt{iat\_jitter\_ms}, \texttt{max\_iat\_ms}, \texttt{pps\_peak\_1s}, \texttt{bps\_peak\_1s}
  (omitted when unavailable).
  \item \texttt{conflicts[]} elements contain: \texttt{universe} (integer), \texttt{sources[]} (array of source identifiers, see Appendix C), \texttt{proto} (string; v0.2 additive, indicates protocol of sources involved), \texttt{overlap\_duration\_s} (float), \texttt{affected\_channels[]} (array of integers or empty), \texttt{severity} (string), and \texttt{conflict\_score} (float). Full definition in Appendix C.
  \item \texttt{compliance[]} elements contain: \texttt{protocol} (string), \texttt{compliance\_percentage} (float; v0.1 emits 100.0 as a placeholder; consumers \MUSTNOT{} rely on it and \MUST{} use \texttt{violations[]} instead),
  and \texttt{violations[]} (array of objects with: \texttt{id} (stable identifier), \texttt{severity} (string; v0.1 uses \texttt{warning} or \texttt{error}),
  \texttt{message} (human-readable explanation), \texttt{count} (integer, total number of occurrences across the capture), and optional
  \texttt{examples[]} (array of at most 3 strings, each containing concise context such as \texttt{"source IP:port @ timestamp"};\\
  payload bytes are not required).
  When present, examples \MUST{} be deduplicated, sorted lexicographically (bytewise), and limited to 3 to keep reports compact and deterministic. Examples are illustrative only and do not affect \texttt{count}.
\end{itemize}

\paragraph{String formatting conventions (v0.1).}
Unless explicitly stated otherwise:
\begin{itemize}
  \item \texttt{source\_ip} is an IP address in textual form (IPv4 dotted-decimal; IPv6 in canonical lowercase compressed form, e.g. RFC5952-style).
  \item \texttt{src} and \texttt{dst} in \texttt{flows[]} are socket addresses formatted as \texttt{ip:port} for IPv4 and \texttt{[ip]:port} for IPv6 (common \texttt{SocketAddr} display form).
  \item Consumers \MUST{} compare these fields as plain strings as emitted (no additional normalization).
\end{itemize}

\subsubsection{Compliance violation IDs (v0.1, non-exhaustive)}
\begin{itemize}
  \item \texttt{LS-UDP-SLICE}: UDP slice error; packet ignored.
  \item \texttt{LS-UDP-MISSING-NETWORK}: missing network layer; packet ignored.
  \item \texttt{LS-UDP-MISSING-PAYLOAD}: missing IP payload; packet ignored.
  \item \texttt{LS-UDP-TOO-SHORT}: UDP payload too short; packet ignored.
  \item \texttt{LS-ARTNET-UNIVERSE-ID}: Art-Net universe id out of range (value $> 0x7FFF$); packet ignored.
  \item \texttt{LS-ARTNET-LENGTH}: ArtDMX length invalid (0 or $> 512$); packet ignored.
  \item \texttt{LS-ARTNET-TOO-SHORT}: payload too short; packet ignored.
  \item \texttt{LS-SACN-START-CODE}: sACN start code is not 0x00; packet ignored.
  \item \texttt{LS-SACN-PROPERTY-COUNT}: sACN property value count is 0 or exceeds 512; packet ignored.
  \item \texttt{LS-SACN-DMX-LENGTH}: sACN DMX data length invalid; packet ignored.
  \item \texttt{LS-SACN-TOO-SHORT}: payload too short; packet ignored.
\end{itemize}

\subsubsection{Determinism rules}
\begin{itemize}
  \item \textbf{Stable ordering:}
  \texttt{universes[]} sorted by \texttt{universe} ascending, then \texttt{proto} ascending;
  \texttt{sources[]} in each universe sorted by \texttt{source\_id} ascending when present (v0.2); for v0.1 compatibility, sort by \texttt{source\_ip} ascending, then \texttt{cid} ascending (when present; absent \texttt{cid} sorts last);
  \texttt{flows[]} sorted by \texttt{src}, then \texttt{dst}, then \texttt{app\_proto};
  \texttt{conflicts[]} sorted by \texttt{universe}, then \texttt{sources} lexicographically;
  \texttt{sources[]} in each conflict record sorted lexicographically by source identifier;
  \texttt{compliance[]} sorted by \texttt{protocol}, then \texttt{violations[]} by severity (\texttt{error} before \texttt{warning}), then \texttt{id}.
  \item \textbf{Volatile fields:} only \texttt{generated\_at} (and optionally \texttt{input.path}) may vary between runs.
  \item \textbf{Floats:} in v0.1, floating-point values are serialized with sufficient precision to keep deterministic JSON output (minimum 6 significant digits). Future versions may define explicit rounding for specific fields.
  \item \textbf{RFC3339:} \texttt{generated\_at}, \texttt{time\_start}, and \texttt{time\_end} use RFC3339 in UTC with the \texttt{Z} suffix.
\end{itemize}

\subsubsection{Example (minimal)}
\begin{verbatim}
{
  "report_version": 1,
  "tool": { "name": "liveshark", "version": "0.1.0" },
  "generated_at": "1970-01-01T00:00:00Z",
  "input": { "path": "capture.pcapng", "bytes": 123456 },
  "capture_summary": null,
  "universes": [],
  "flows": [],
  "conflicts": [],
  "compliance": []
}
\end{verbatim}

\subsubsection{Example (conflict record)}
\begin{verbatim}
{
  "universe": 1,
  "sources": [
    "sacn:cid:11223344556677889900aabbccddeeff",
    "artnet:192.168.0.2:6454"
  ],
  "overlap_duration_s": 3.5,
  "affected_channels": [],
  "severity": "medium",
  "conflict_score": 3.5
}
\end{verbatim}

\subsection{Appendix B --- DMX frame reconstruction contract (v0.1)}
\subsubsection{Canonical DMX frame definition}
A reconstructed DMX frame is defined by:
\begin{itemize}
  \item \textbf{universe}: 16-bit universe identifier.
  \item \textbf{timestamp}: capture time (packet timestamp).
  \item \textbf{source\_id}: stable source identity (see Appendix C).
  \item \textbf{protocol}: \texttt{artnet} or \texttt{sacn}.
  \item \textbf{slots[512]}: 512 DMX slot values (0--255).
\end{itemize}

\subsubsection{Universe normalization}
The canonical universe is the 16-bit integer decoded from the protocol payload. For Art-Net, it is computed from the
ArtDMX \texttt{Net} (high byte) and \texttt{SubUni} (low byte) fields, with \texttt{universe\_id = 256 * net + subuni}
(0..32767). \texttt{Net} and \texttt{SubUni} are single-byte fields; \texttt{universe\_id} uses \texttt{Net} as the high byte
and \texttt{SubUni} as the low byte (not a little-endian 16-bit field). For sACN, it is the big-endian \texttt{universe}
field from the framing layer. The report uses this
canonical value; the same universe means identical numeric values across protocols.

\subsubsection{Minimal reconstruction rules}
\begin{itemize}
  \item Frames are reconstructed per universe, per source, and per protocol, using validated protocol payloads.
  \item Before the first observed frame for a given (universe, source, protocol), slot values default to 0.
  \item If a payload provides fewer than 512 slots, missing slots retain the last known value for that (universe, source, protocol).
  \item Reconstructed frames always expose 512 slots.
  \item Out-of-order frames are accepted; reconstruction and metrics are heuristic, without panic.
  \item FPS counts frames that pass protocol validation and are assigned to a universe.
\end{itemize}

\subsection{Appendix C --- Conflict detection contract (v0.1)}
\subsubsection{Source identity}
\begin{itemize}
  \item \textbf{sACN:} \texttt{sacn:cid:<CID>} when CID is present; otherwise fallback to \texttt{sacn:<ip>:<port>}.
  \item \textbf{Art-Net:} \texttt{artnet:<ip>:<port>}.
\end{itemize}
\textbf{CID format:} lowercase hexadecimal, 32 characters, no separators.

\subsubsection{Overlap definition}
Conflict is defined as: same universe, at least two sources, and overlap duration $> 1.0$ s.
Overlap is computed from the per-source time ranges \texttt{[first\_ts, last\_ts]} and the intersection duration.
In v0.1, conflict detection is a conservative approximation based on time overlap; any overlap $> 1.0$ s triggers a
conflict, even if sources do not actively compete on the same channels at the same time. The false-positive rate is not
quantified in v0.1; conflicts are signals to investigate. \texttt{affected\_channels[]} is best-effort and may be empty
when channel-level evidence cannot be derived from the overlap window.

\subsubsection{Conflict record fields}
\begin{itemize}
  \item \texttt{universe} (integer)
  \item \texttt{sources[]} (array of source identifiers)
  \item \texttt{overlap\_duration\_s} (float seconds)
  \item \texttt{affected\_channels[]} (array of integers; best-effort from overlap window, may be empty in v0.1)
  \item \texttt{severity} (string)
  \item \texttt{conflict\_score} (float)
\end{itemize}
In v0.1, \texttt{severity} is fixed to \texttt{"medium"} and \texttt{conflict\_score} equals \texttt{overlap\_duration\_s}.
Optional (planned, non-normative): \texttt{first\_seen}, \texttt{last\_seen}, and \texttt{protocols[]}.

\subsection{Appendix D --- Metric definitions (v0.1)}
\begin{itemize}
  \item \textbf{pps/bps:} packets/bytes per second averaged over the flow active interval $[t_{first}, t_{last}]$. Units are packets/s and bytes/s. Omit if fewer than two timestamped packets exist, if $t_{last} == t_{first}$, or if the active duration is unavailable. (Reported in \texttt{flows[]}.)
  \item \textbf{fps (universe):} reconstructed DMX frames per second over a 5.0 s sliding window; unit is frames/s. The reported value is the rate over the last 5.0 s window ending at the last observed timestamp.
  \item \textbf{IAT jitter (diagnostic):} mean absolute variation between consecutive inter-arrival times over a 10.0 s sliding window: $\text{mean}(|IAT_i - IAT_{i-1}|)$. Unit is milliseconds for \texttt{iat\_jitter\_ms} and \texttt{jitter\_ms}. The reported value is the peak (maximum) over all windows.
  \item \textbf{loss (observed):} for sources with reliable sequence numbers (v0.1: sACN), loss is the sum of observed sequence gaps over a 10.0 s sliding window; for sACN, gaps are computed per source using the modulo-256 delta rule above; only $\Delta \in [2,127]$ contributes missing packets as $(\Delta-1)$.\\
  \texttt{loss\_rate} is \texttt{loss\_packets / (loss\_packets + seq\_tracked\_frames)}\\
  where \texttt{seq\_tracked\_frames} is the number of frames observed with sequence numbers in the same 10.0 s window. If sequence numbers are unavailable, loss fields \MUST{} be omitted.
  \item \textbf{bursts:} for sequence-tracked sources (v0.1: sACN), \texttt{burst\_count} is the number of loss bursts over a 10.0 s sliding window; \texttt{max\_burst\_len} is the maximum burst length observed in the same window. If sequence numbers are unavailable, burst fields \MUST{} be omitted.
\end{itemize}

\subsection{Appendix D.1 --- Additional diagnostic metrics (additive)}
\begin{itemize}
  \item \textbf{max\_iat\_ms:} per flow, maximum observed inter-arrival time $\max(t_i - t_{i-1})$ over the capture. Unit: milliseconds, integer rounded to nearest. Omit when fewer than two packets with timestamps exist.
  \item \textbf{pps\_peak\_1s / bps\_peak\_1s:} per flow, peak packets/s and bytes/s over a 1.0 s sliding window, with inclusion rule $[t-1.0, t]$. Report the maximum window count as an integer. Omit when fewer than two packets with timestamps exist or when the covered duration is $< 1.0$ s.
  \item \textbf{dup\_packets / reordered\_packets:} per universe, counts are computed \textbf{per sACN source (CID)} in capture-time order and summed. For each source, let the modulo-256 delta be $\Delta = (\texttt{seq} - \texttt{seq\_prev}) \bmod 256$. If $\Delta = 0$, increment \texttt{dup\_packets}. If $\Delta = 1$, the packet is in-order. If $\Delta \in [2, 127]$, it indicates missing packets and contributes $(\Delta - 1)$ to the observed loss count. If $\Delta \in [128, 255]$ (backward half-range), increment \texttt{reordered\_packets}; backward-half deltas \textbf{do not} contribute to loss. Wrap-around (e.g., 254, 255, 0, 1) is in-order. Omit when no sequence numbers are available.
\end{itemize}

\section{Licensing}
Code is licensed under \textbf{MIT OR Apache-2.0}. Documentation and specifications are licensed under \textbf{CC-BY-4.0}.
PDF files are build artifacts generated from the \texttt{.tex} sources and \textbf{should not be committed} to the repository.

\section{Normative references}
\begin{adjustbox}{max width=\linewidth}
\begin{tabularx}{\linewidth}{@{}l >{\raggedright\arraybackslash}X@{}}
\toprule
\textbf{Reference} & \textbf{Title} \\
\midrule
RFC 2119 & Key words for use in RFCs to Indicate Requirement Levels \\
RFC 8174 & Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words \\
RFC 3339 & Date and Time on the Internet: Timestamps \\
ANSI E1.31-2018 & Streaming ACN (sACN) \\
Art-Net 4 & Art-Net 4 Specification (Protocol Release) \\
\bottomrule
\end{tabularx}
\end{adjustbox}

\subsection{Appendix E --- v0.2 additive schema fields}

This appendix documents optional fields added in v0.2 of the JSON report contract. These fields are \textit{additive} and do not affect \texttt{report\_version}; compliant v0.1 consumers \MUST{} tolerate their presence and \MUSTNOT{} treat them as incompatibilities. All v0.2 fields use \texttt{skip\_serializing\_if} semantics: they are omitted from the JSON output when null or absent, ensuring backward compatibility with existing v0.1 workflows.

\subsubsection{SourceSummary.source\_id (optional string, v0.2)}
\begin{itemize}
  \item \textbf{Purpose:} Provide a stable, deterministic identifier for each source to enable GUI compare/timeline features that require reliable cross-report source tracking. This field is opaque; consumers \MUST{} treat it as a stable key, not decompose its structure.
  \item \textbf{Format (recommended):} The recommended format is informational only and \MUSTNOT{} be used for parsing logic. Consumers \SHOULD{} treat \texttt{source\_id} as an opaque string. For informational purposes, the pattern is \texttt{proto:source}, where \texttt{proto} is the protocol name and \texttt{source} is the endpoint. Specifically:
  \begin{itemize}
    \item \texttt{artnet:<ip>:<port>} for Art-Net (e.g., \texttt{artnet:192.168.0.1:6454}).
    \item \texttt{sacn:<ip>:<port>} for sACN with IP endpoint (e.g., \texttt{sacn:10.0.0.1:5568}).
    \item \texttt{sacn:cid:<CID>} for sACN with CID priority (e.g., \texttt{sacn:cid:000102030405060708090a0b0c0d0e0f}); \texttt{CID} is lowercase hexadecimal, 32 characters, no separators.
    \item IPv6 endpoints use canonical compressed form, bracketed: \texttt{artnet:[2001:db8::1]:6454}, \texttt{sacn:[fe80::1]:5568}.
  \end{itemize}
  \item \textbf{Stability:} Within a single report, \texttt{source\_id} \MUST{} be stable and deterministic for a given source (same source identity \ensuremath{\Rightarrow} same identifier, deterministic sorting). Across reports, \texttt{source\_id} \SHOULD{} remain stable when the underlying identity remains stable (e.g., same sACN CID or same IP:port endpoint).
  \item \textbf{Availability:} Always populated in v0.2 when a \texttt{SourceSummary} is emitted. Absent (null) in v0.1.
  \item \textbf{Sorting impact:} When present in v0.2, \texttt{sources[]} are sorted by \texttt{source\_id} ascending (superseding the v0.1 rule of sorting by \texttt{source\_ip}, then \texttt{cid}).
  \item \textbf{Consumer guidance:} v0.1 consumers may ignore this field. v0.2 consumers \SHOULD{} use \texttt{source\_id} as the primary stable key for cross-report comparisons and GUI state tracking; it is more reliable than \texttt{source\_ip} alone.
\end{itemize}

\subsubsection{ConflictSummary.proto (optional string, v0.2)}
\begin{itemize}
  \item \textbf{Purpose:} Indicate the protocol of the sources involved in a conflict. Enables protocol-specific GUI rendering, conflict resolution strategies, and extensibility for future protocols.
  \item \textbf{Format:} Lowercase ASCII protocol name (case-sensitive). v0.2 emits \texttt{artnet} or \texttt{sacn}. Future versions \MAY{} emit other protocol names; consumers \SHOULD{} be prepared to encounter unknown values.
  \item \textbf{Semantics:} A conflict record always involves sources from the same protocol; hence \texttt{proto} is a single string, not per-source. All sources listed in \texttt{sources[]} belong to the protocol named in \texttt{proto}.
  \item \textbf{Availability:} Always populated in v0.2 for each \texttt{ConflictSummary} record. Absent (null) in v0.1.
  \item \textbf{Consumer guidance:} v0.1 consumers may ignore this field. v0.2 consumers \SHOULD{} use \texttt{proto} to tag conflict summaries and enable protocol-aware filtering or rendering in the GUI. Consumers \MUST{} treat unknown \texttt{proto} values as opaque strings and display/pass-through as-is without attempting to interpret them.
\end{itemize}

\nocite{rfc2119,rfc8174,rfc3339,e1312018,artnet4}
\printbibliography

\end{document}
